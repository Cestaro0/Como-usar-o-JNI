# Como usar o JNI
Imagine que você é um desenvolvedor precisa utilizar uma DLL em C++ por meio do java, com JNI isso se torna possível. 
Estou fazendo essa documentação bem simples, pois tive alguns problemas em entender tudo. Espero ajudar, vamos abordar os seguintes temas:
- O que é JNI
- Como usar o JNI passo a passo

Vamos usar o Intellij e Visual Studio para isso.

## Configurar o Java
 Bom, primeiramente para começarmos a usar tudo que foi proposto, precisamos baixar o JDK (Java Development Kit) do java e configurar sua máquina para tal.
Lembrete: Caso sua aplicação seja x64 baixe a versão x64, caso seja x32 precisamos baixar uma versão mais antigas, porque o java parou de criar as versões x32 dês do java 8.
Acesse o link do jdk 11, baixe e automaticamente vai ser configurado nas suas variaveis de ambiente. Mas caso não seja, siga os seguintes passos:
Abra o terminal e digite:
```bash
C:\Users>setx JAVA_HOME "C:\Program Files\Java\jdk-xx.x.x"
C:\Users>setx PATH "%JAVA_HOME%\bin"
```
Pronto está configurado, agora vc precisa receber essa mensagem:
```bash
C:\Users>java --version
java 11.0.16.1 2022-08-18 LTS
Java(TM) SE Runtime Environment 18.9 (build 11.0.16.1+1-LTS-1)
Java HotSpot(TM) 64-Bit Server VM 18.9 (build 11.0.16.1+1-LTS-1, mixed mode)
```

## JNI
Agora vamos falar sobre o JNI(Java Native Interface), ele é simplesmente - a grosso modo - uma maneira que a oracle criou para fazer a comunicação de java com C++, também temos o JNA que é mantido por uma comunidade do github (mas não falaremos dela aqui). Abaixo uma imagem de exemplo
<img src="/img/JNI.png">
Aqui vemos que o JNI faz o intermédio entre a JVM e a .dll c++ onde ele vai rodar o codigo java que por sua vez chama as funções do C++. 
A .dll é criada com uma mistura de java e c++ em um cabeçalho jni.

## Criação do projeto java
Primeiramente baixe a plataforma do IntelliJ, após isso crie um projeto, pode ser intellij, grandle ou maven, tanto faz.
```java
public class CallCppFromJava {

    public static native String sayWrapperHello();
    public static native String sayCppDllHello(String str);
    public static native int sumWrapper(int a, int b);
    public static native int sumCppDll(int a, int b);

    public static void main(String[] args) {

    }
}

```
<img src="/img/java-example.png">

Aqui criamos 4 métodos, onde vão ser 2 pela nossa dll JNI, que chamaremos de wrapper a partir de agora e outros dois que serão retornados pela dll nativa C++.

Não se esqueça de gerar o cabeçalho .h (digitado no terminal), isso é uma peça chave para nós.


## C++
Crie uma DLL C++ nativa pelo visual studio:
```c++
#include "pch.h"

BOOL APIENTRY DllMain( HMODULE hModule,
                       DWORD  ul_reason_for_call,
                       LPVOID lpReserved
                     )
{
    switch (ul_reason_for_call)
    {
    case DLL_PROCESS_ATTACH:
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
        break;
    }
    return TRUE;
}

extern "C" __declspec (dllexport) const char* sayCppHello(const char* str)
{
    return str;
}

extern "C" __declspec (dllexport) int sumCppDll(int a, int b)
{
    return a + b;
}
```
Agora vamos fazer o wrapper. Crie uma DLL C++ nativa, porém dessa vez adicione o .h gerado do java
```c++
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
#include <iostream>
#include <Windows.h>
/* Header for class CallCppFromJava */

#ifndef _Included_CallCppFromJava
#define _Included_CallCppFromJava
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     CallCppFromJava
 * Method:    sayWrapperHello
 * Signature: ()Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_CallCppFromJava_sayWrapperHello
  (JNIEnv *, jclass);

/*
 * Class:     CallCppFromJava
 * Method:    sayCppDllHello
 * Signature: (Ljava/lang/String;)Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_CallCppFromJava_sayCppDllHello
  (JNIEnv *, jclass, jstring);

/*
 * Class:     CallCppFromJava
 * Method:    sumWrapper
 * Signature: (II)I
 */
JNIEXPORT jint JNICALL Java_CallCppFromJava_sumWrapper
  (JNIEnv *, jclass, jint, jint);

/*
 * Class:     CallCppFromJava
 * Method:    sumCppDll
 * Signature: (II)I
 */
JNIEXPORT jint JNICALL Java_CallCppFromJava_sumCppDll
  (JNIEnv *, jclass, jint, jint);

#ifdef __cplusplus
}
#endif
#endif

```
<img src="/img/wrapper-cpp.png">
Agora iremos criar o .cc que vamos gerenciar tudo.
Mas antes, vá em 

```
propriedades > C/C++ > Diretórios de inclusão adicionais e inclua "C:\Program Files\Java\jdk-11.0.16.1\include" "C:\Program Files\Java\jdk-11.0.16.1\include\win32", desative o cabeçalho pre compilado
```
e clique em aplicar, irá ficar assim seu .cc
```c++
#include "CallCppFromJava.h"

extern "C"
{
	JNIEXPORT jstring JNICALL Java_CallCppFromJava_sayWrapperHello(JNIEnv* env, jclass cls)
	{
		return env->NewStringUTF("Hello From Wrapper");
	}

	JNIEXPORT jstring JNICALL Java_CallCppFromJava_sayCppDllHello(JNIEnv* env, jclass cls, jstring str)
	{
		const char* cppStr = env->GetStringUTFChars(str, JNI_FALSE);
		HMODULE hModule = LoadLibraryA("D:\\DEV\\JNI\\Dll2\\x64\\Release\\Dll2.dll");
		typedef const char* (*sayCppHello)(const char*);
		sayCppHello hello = (sayCppHello)GetProcAddress(hModule, "sayCppHello");
		return env->NewStringUTF(hello(cppStr));
	}

	JNIEXPORT jint JNICALL Java_CallCppFromJava_sumWrapper(JNIEnv* env, jclass cls, jint a, jint b)
	{
		return a + b;
	}

	JNIEXPORT jint JNICALL Java_CallCppFromJava_sumCppDll(JNIEnv* env, jclass cls, jint a, jint b)
	{
		HMODULE hModule = LoadLibraryA("D:\\DEV\\JNI\\Dll2\\x64\\Release\\Dll2.dll");
		typedef int (*sumCppDll)(int, int);
		sumCppDll sum = (sumCppDll)GetProcAddress(hModule, "sumCppDll");
		return sum(a,b);
	}
}
```
<img src="/img/cc.png">
Agora compile na sua arquitetura e volte para o java

## Call cpp
Voltando para o java, vamos apenas fazer as chamadas das funções.

```java

public class CallCppFromJava {
    static{
        System.load("D:\\DEV\\JNI\\Dll3\\x64\\Release\\Dll3.dll");
    }

    public static native String sayWrapperHello();
    public static native String sayCppDllHello(String str);
    public static native int sumWrapper(int a, int b);
    public static native int sumCppDll(int a, int b);

    public static void main(String[] args) {
        System.out.println("sayWrapperHello: " + sayWrapperHello());
        System.out.println("sayCppDllHello: " + sayCppDllHello("Hello"));
        System.out.println("sumWrapper: " + sumWrapper(1, 2));
        System.out.println("sumCppDll: " + sumCppDll(1, 2));
    }
}
```
output:
```bash
sayWrapperHello: Hello From Wrapper
sayCppDllHello: Hello
sumWrapper: 3
sumCppDll: 3
```
